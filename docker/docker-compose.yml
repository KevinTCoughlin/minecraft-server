version: "3.9"

services:
  minecraft:
    image: itzg/minecraft-server:java21
    container_name: minecraft-server
    restart: unless-stopped
    tty: true
    stdin_open: true

    ports:
      - "25565:25565"     # Minecraft
      - "25575:25575"     # RCON

    environment:
      # Server type
      TYPE: "PAPER"
      VERSION: "1.21.4"
      EULA: "TRUE"

      # Memory settings with experimental JVM features
      MEMORY: "4G"
      JVM_OPTS: >-
        -XX:+UseG1GC
        -XX:+ParallelRefProcEnabled
        -XX:MaxGCPauseMillis=200
        -XX:+UnlockExperimentalVMOptions
        -XX:+DisableExplicitGC
        -XX:+AlwaysPreTouch
        -XX:G1NewSizePercent=30
        -XX:G1MaxNewSizePercent=40
        -XX:G1HeapRegionSize=8M
        -XX:G1ReservePercent=20
        -XX:G1HeapWastePercent=5
        -XX:G1MixedGCCountTarget=4
        -XX:InitiatingHeapOccupancyPercent=15
        -XX:G1MixedGCLiveThresholdPercent=90
        -XX:G1RSetUpdatingPauseTimePercent=5
        -XX:SurvivorRatio=32
        -XX:+PerfDisableSharedMem
        -XX:MaxTenuringThreshold=1
        -Dusing.aikars.flags=https://mcflags.emc.gs
        -Daikars.new.flags=true

      # Server settings
      SERVER_NAME: "My PaperMC Server"
      MOTD: "A PaperMC Server - Powered by Docker"
      DIFFICULTY: "normal"
      MODE: "survival"
      MAX_PLAYERS: 20
      ONLINE_MODE: "true"
      VIEW_DISTANCE: 10
      SIMULATION_DISTANCE: 10
      SPAWN_PROTECTION: 16
      # Experimental features
      INITIAL_ENABLED_PACKS: "vanilla,bundle"

      # RCON
      ENABLE_RCON: "true"
      RCON_PASSWORD: "changeme"
      RCON_PORT: 25575

      # Misc
      ENABLE_COMMAND_BLOCK: "false"
      ALLOW_FLIGHT: "false"
      PVP: "true"

      # Timezone
      TZ: "UTC"

      # Auto-pause (optional - saves resources when no players)
      # ENABLE_AUTOPAUSE: "true"
      # AUTOPAUSE_TIMEOUT_EST: 600

    volumes:
      # Persist world data
      - minecraft-data:/data

      # Mount configuration files (optional - for customization)
      - ../server/server.properties:/data/server.properties:ro
      - ../server/paper-global.yml:/data/config/paper-global.yml:ro
      - ../server/paper-world-defaults.yml:/data/config/paper-world-defaults.yml:ro
      - ../server/bukkit.yml:/data/bukkit.yml:ro
      - ../server/spigot.yml:/data/spigot.yml:ro

      # Mount plugins
      - ../server/plugins:/data/plugins

    healthcheck:
      test: mc-health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 2m

    # Resource limits (optional)
    deploy:
      resources:
        limits:
          memory: 6G
        reservations:
          memory: 2G

volumes:
  minecraft-data:
    name: minecraft-server-data

# Additional services for production deployments
# Uncomment as needed

# networks:
#   default:
#     name: minecraft-network

# services:
#   # Velocity proxy for multiple servers
#   velocity:
#     image: itzg/mc-proxy
#     ports:
#       - "25577:25577"
#     environment:
#       TYPE: VELOCITY
#     volumes:
#       - velocity-data:/server
#
#   # Backup service
#   backup:
#     image: itzg/mc-backup
#     environment:
#       BACKUP_INTERVAL: "24h"
#       RCON_HOST: minecraft
#       RCON_PORT: 25575
#       RCON_PASSWORD: changeme
#     volumes:
#       - minecraft-data:/data:ro
#       - ./backups:/backups
